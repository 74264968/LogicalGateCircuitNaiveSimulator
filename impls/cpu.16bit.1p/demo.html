<!DOCTYPE html>
<html>
<head>
  <style>
    button {border:1px solid #338; padding:4px;}
    button:hover {border:1px solid #996;cursor:pointer}
    .active {background-color: #33aa44; color:#eef}
    .inactive {background-color: none;}
  </style>
  <script language="javascript" src="/core/fundamental/gates.js"></script>
  <script language="javascript" src="/core/fundamental/simulating.js"></script>
  <script language="javascript" src="/core/prefabs/stateful.js"></script>
  <script language="javascript" src="/core/prefabs/stateless.js"></script>
  <script language="javascript" src="/core/prefabs/alu.js"></script>
  <script language="javascript" src="/core/prefabs/clock-driven-state-machine.js"></script>
  <script language="javascript" src="/visualization/time-sequence.js"></script>
  <script language="javascript" src="/visualization/input-interfaces.js"></script>
  <script language="javascript" src="/visualization/screen.js"></script>
  <script language="javascript" src="/visualization/dec-display.js"></script>
  <script language="javascript" src="/visualization/tracer.js"></script>
  <script language="javascript" src="/scaffold/helpers.js"></script>
  <script language="javascript" src="/fake/fake-rwmemory.js"></script>
  <script language="javascript" src="./cpu.16bit.1p.js"></script>
  <script language="javascript">
  function Onload( ) {
    var clk = new Clock( 1, 50 );
    var mon_sigs = [];
    var simulator = new Simulator( [], 0 );
    var tm = new TimeSequenceMonitor( mon_sigs, "timeseq", 768 );
    //var screen = new PixelScreen( sigs, "screen", 64, 64, 8 );
    var loop = new MainLoop( simulator, 1, 10 );
    var reset = CreateInputSwitch( 0, "signalPanel", "reset", simulator );
    var start = CreateInputSwitch( 0, "signalPanel", "start", simulator );
    var cpu = new Cpu16Bit1P( clk, reset, start, "cpu" );
    var initial_bytes = [
      parseInt('00100000'.split('').reverse().join(''),2),0,1,2,

      parseInt('01001000'.split('').reverse().join(''),2),
      parseInt('00000001'.split('').reverse().join(''),2),
      3,4,

      parseInt('10010000'.split('').reverse().join(''),2),
      parseInt('00000010'.split('').reverse().join(''),2),
      5,6,

      parseInt('10111000'.split('').reverse().join(''),2),0,7,8,
    ];
    initial_bytes = initial_bytes.concat( initial_bytes );
    initial_bytes = initial_bytes.concat( initial_bytes );
    var mem = new FakeRWMemory( cpu.ADDR_WIDTH, cpu.MEM_READ_WIDTH / 8, "64k.mem", initial_bytes ); 
    cpu.connect_memory( mem );
    window.cpu = cpu;

    Add2Simulator( simulator, cpu.network );
    Add2Simulator( simulator, mem.network );
    loop.register_monitor( tm );
    loop.register_monitor( new DecimalDisplay( cpu.conn_addressing_mode, false, "controlPins", "am" ) );
    loop.register_monitor( new DecimalDisplay( [cpu.addressing_mode['imm']], false, "controlPins", "am.imm" ) );
    loop.register_monitor( new DecimalDisplay( [cpu.addressing_mode['index']], false, "controlPins", "am.index" ) );
    loop.register_monitor( new DecimalDisplay( [cpu.addressing_mode['index_ax']], false, "controlPins", "am.index_ax" ) );
    loop.register_monitor( new DecimalDisplay( [cpu.addressing_mode['index_bx']], false, "controlPins", "am.index_bx" ) );
    loop.register_monitor( new DecimalDisplay( [cpu.dst_ax], false, "controlPins", "dst_ax" ) );
    loop.register_monitor( new DecimalDisplay( [cpu.dst_bx], false, "controlPins", "dst_bx" ) );
    loop.register_monitor( new DecimalDisplay( cpu.conn_ax, false, "controlPins", "AX", true ) );
    loop.register_monitor( new DecimalDisplay( cpu.conn_bx, false, "controlPins", "BX", true ) );
    loop.register_monitor( new DecimalDisplay( cpu.IP.map( (x)=>x.get_output_endpoint() ), false, "digitPanel", "IP:" ) );
    loop.register_monitor( new DecimalDisplay( cpu.simple_next_ip, false, "digitPanel", "IP+4: " ) );
    loop.register_monitor( new DecimalDisplay( cpu.conn_IP_input, false, "digitPanel", "next_IP: " ) );
    loop.register_monitor( new DecimalDisplay( cpu.select_next_ip, false, "digitPanel", "selected_IP: " ) );
    loop.register_monitor( new DecimalDisplay( cpu.ms_memory_addr.get_output_endpoints(), false, "digitPanel", "mem_read_addr: " ) );
    loop.register_monitor( new DecimalDisplay( cpu.instruction_input, false, "digitPanel", "instruction_input: " ) );
    loop.register_monitor( new DecimalDisplay( cpu.instruction.map( (x) => x.get_output_endpoint() ), false, "digitPanel", "instruction: ", true ) );
    loop.register_monitor( new DecimalDisplay( cpu.instruction.slice(0,3).map( (x) => x.get_output_endpoint() ), false, "digitPanel", "instruction(cycle): " ) );
    loop.register_monitor( new DecimalDisplay( cpu.conn_cmd_cycle, false, "digitPanel", "cycle: " ) );
    loop.register_monitor( new DecimalDisplay( cpu.conn_i_operand, false, "digitPanel", "i_operand: ", true ) );
    //loop.register_monitor( screen );
    var sm = cpu.state_machine;
    function update( )
    {
      loop.update();
    }
    //monitoring cpu running state
    {
    mon_sigs.push( clk );
    mon_sigs.push( cpu.ip_enable );
    mon_sigs.push( sm.get_output_endpoint_of_is_state( "INIT" ));
    mon_sigs.push( sm.get_output_endpoint_of_is_state( "FETCH" ));
    mon_sigs.push( sm.get_output_endpoint_of_is_state( "DECODE"));
    for( var i = 0 ; i < 8 ; i++ ) {
      mon_sigs.push( sm.get_output_endpoint_of_is_state( "EXEC_" + i ));
    }
    mon_sigs.push( sm.get_output_endpoint_of_is_state( "STORE" ));
    cpu.instruction.slice(0,8).map( (x) => { mon_sigs.push( x.get_output_endpoint() ) } );
    }
    setInterval( update, loop.frame_in_ms );
    loop.start();

    var btnResume = document.getElementById("btnResume");
    btnResume.onclick = function() { loop.resume(); }

    var btnStop = document.getElementById("btnStop");
    btnStop.onclick = function() { loop.pause(); }

  }
  </script>
</head>
<body onload="javascript:Onload()">
  <div>
  <button id="btnResume">resume</button>
  <button id="btnStop">stop</button>
  </div>
  <div id="signalPanel" style="padding: 20px"></div>
  <div id="controlPins" style="padding: 20px;display:inline-block"></div>
  <div id="digitPanel" style="padding: 20px"></div>
  <div>
  <canvas id="screen"></canvas>
  </div>
  <div>
  <canvas id="timeseq"></canvas>
  </div>
</body>
</html>
